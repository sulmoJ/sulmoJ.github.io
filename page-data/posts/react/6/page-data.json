{"componentChunkName":"component---src-templates-post-template-js","path":"/posts/react/6","result":{"data":{"markdownRemark":{"id":"ee0050d4-18e6-5d06-8372-a577b57f79d1","html":"<blockquote>\n<p>AUSG 5기 스터디 FE-Deep-Dive 중 Build your own react를 참고해 작성된 포스트입니다.</p>\n</blockquote>\n<h2 id=\"step-7--function-components\" style=\"position:relative;\"><a href=\"#step-7--function-components\" aria-label=\"step 7  function components permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Step 7 : Function Components</h2>\n<p>이번엔 함수형 컴포넌트를 지원할수있도록 해봅니다.</p>\n<p>함수형 컴포넌트 파이버는 기존의 파이버와 두가지 차이가 있습니다.</p>\n<ul>\n<li>함수형 컴포넌트의 파이버는 돔노드가 없다.</li>\n<li>파이버의 자식요소는 실행 중인 함수에서 가져오는데, 대신 props로부터 바로 얻습니다.</li>\n</ul>\n<p>일단 이렇게만 알아두고 코드로 넘어가 보겠습니다.</p>\n<br/>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">performUnitOfWork</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fiber</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> isFunctionComponent <span class=\"token operator\">=</span> fiber<span class=\"token punctuation\">.</span>type <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">Function</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isFunctionComponent<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">updateFunctionComponent</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">updateHostComponent</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>파이버의 타입을 체크해 업데이트 방식을 나눕니다.</p>\n<br/>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">updateFunctionComponent</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fiber</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// TODO</span>\n<span class=\"token punctuation\">}</span>\n​\n<span class=\"token keyword\">function</span> <span class=\"token function\">updateHostComponent</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fiber</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>fiber<span class=\"token punctuation\">.</span>dom<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    fiber<span class=\"token punctuation\">.</span>dom <span class=\"token operator\">=</span> <span class=\"token function\">createDom</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token function\">reconcileChildren</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">,</span> fiber<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">updateHostComponent</code>함수는 기존의 파이버를 업데이트하는 방식이라 차이가 없습니다.</p>\n<br/>\n<p>함수형 컴포넌트 업데이트 방식 처리를 위해 분리되었는데, <code class=\"language-text\">updateFunctionComponent</code> 함수에서는 함수형 컴포넌트의 children을 가져오기위해 만들어진 함수입니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">updateFunctionComponent</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fiber</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> children <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>fiber<span class=\"token punctuation\">.</span><span class=\"token function\">type</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n  <span class=\"token function\">reconcileChildren</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">,</span> children<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>위에서 본 두가지 차이점 중 두번째가 이 부분인 듯 합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">App</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">props</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">&lt;</span>h1<span class=\"token operator\">></span>Hi <span class=\"token punctuation\">{</span>props<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">}</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>h1<span class=\"token operator\">></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>위와 같은 함수가 현재 type에 들어있으면, 지금 App이라는 파이버는 아래처럼 존재 하고</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token punctuation\">{</span>\n  type<span class=\"token operator\">:</span> App<span class=\"token punctuation\">,</span>\n  props<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    name<span class=\"token operator\">:</span><span class=\"token string\">'foo'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>여기서 <code class=\"language-text\">fiber.type(fiber.props)</code>처럼 함수 실행중 props를 바로 가져다 사용하게 됩니다. 이렇게 App함수는 h1 앨리먼트를 반환해 재조정에 들어갑니다.</p>\n<br/>\n<p>다음으로 수정이 필요한 부분은 <code class=\"language-text\">commitWork</code>함수입니다.</p>\n<p>아래 코드가 기존 <code class=\"language-text\">commitWork</code>함수입니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">commitWork</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fiber</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>fiber<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span>\n  <span class=\"token punctuation\">}</span>\n​\n  <span class=\"token keyword\">const</span> domParent <span class=\"token operator\">=</span> fiber<span class=\"token punctuation\">.</span>parent<span class=\"token punctuation\">.</span>dom\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\n    fiber<span class=\"token punctuation\">.</span>effectTag <span class=\"token operator\">===</span> <span class=\"token string\">\"PLACEMENT\"</span> <span class=\"token operator\">&amp;&amp;</span>\n    fiber<span class=\"token punctuation\">.</span>dom <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span>\n  <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    domParent<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>dom<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>\n    fiber<span class=\"token punctuation\">.</span>effectTag <span class=\"token operator\">===</span> <span class=\"token string\">\"UPDATE\"</span> <span class=\"token operator\">&amp;&amp;</span>\n    fiber<span class=\"token punctuation\">.</span>dom <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span>\n  <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">updateDom</span><span class=\"token punctuation\">(</span>\n      fiber<span class=\"token punctuation\">.</span>dom<span class=\"token punctuation\">,</span>\n      fiber<span class=\"token punctuation\">.</span>alternate<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">,</span>\n      fiber<span class=\"token punctuation\">.</span>props\n    <span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>effectTag <span class=\"token operator\">===</span> <span class=\"token string\">\"DELETION\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    domParent<span class=\"token punctuation\">.</span><span class=\"token function\">removeChild</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>dom<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n​\n  <span class=\"token function\">commitWork</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>child<span class=\"token punctuation\">)</span>\n  <span class=\"token function\">commitWork</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>sibling<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>첫번째 특징에 함수형 컴포넌트는 <code class=\"language-text\">파이버의 형태에서 dom을 가지고 있지 않다</code> 라고 했습니다.</p>\n<p>그래서 commit작업에서 DOM노드가 없는 파이버에대한 처리를 두가지 정도 해줘야 합니다.</p>\n<br/>\n첫번째로\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// 기존 코드</span>\n<span class=\"token keyword\">const</span> domParent <span class=\"token operator\">=</span> fiber<span class=\"token punctuation\">.</span>parent<span class=\"token punctuation\">.</span>dom\n\n<span class=\"token comment\">// 이렇게 바꿔줍니다.</span>\n<span class=\"token keyword\">let</span> domParentFiber <span class=\"token operator\">=</span> fiber<span class=\"token punctuation\">.</span>parent\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>domParentFiber<span class=\"token punctuation\">.</span>dom<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    domParentFiber <span class=\"token operator\">=</span> domParentFiber<span class=\"token punctuation\">.</span>parent\n  <span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">const</span> domParent <span class=\"token operator\">=</span> domParentFiber<span class=\"token punctuation\">.</span>dom</code></pre></div>\n<p>기존 파이버에서 1촌 부모 파이버의 돔노드를 가져왔다면, 함수형 컴포넌트 파이버를 고려해, 가장 가까운 직계조상 파이버의 DOM노드를 찾을때까지 반복문을 돌립니다.</p>\n<br/>\n<p>두번째로</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> commitWork<span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...</span>\n  <span class=\"token comment\">// 기존</span>\n  domParent<span class=\"token punctuation\">.</span><span class=\"token function\">removeChild</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>dom<span class=\"token punctuation\">)</span>\n\n  <span class=\"token comment\">// 변경 후</span>\n  <span class=\"token function\">commitDeletion</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">,</span> domParent<span class=\"token punctuation\">)</span>\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">commitDeletion</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fiber<span class=\"token punctuation\">,</span> domParent</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>dom<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    domParent<span class=\"token punctuation\">.</span><span class=\"token function\">removeChild</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>dom<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">commitDeletion</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>child<span class=\"token punctuation\">,</span> domParent<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>기존에 DOM노드 삭제 과정에서도 마찬가지로 직계 자손에 DOM노드가 존재하는지의 여부를 체크하며 재귀를 통해 찾아줍니다.</p>\n<h2 id=\"step-8--hooks\" style=\"position:relative;\"><a href=\"#step-8--hooks\" aria-label=\"step 8  hooks permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Step 8 : Hooks</h2>\n<p>이번엔 함수형 컴포넌트에 상태를 추가해 보겠습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">Counter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>state<span class=\"token punctuation\">,</span> setState<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> Didact<span class=\"token punctuation\">.</span><span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token operator\">&lt;</span>h1 onClick<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">c</span> <span class=\"token operator\">=></span> c <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token operator\">></span>\n      Count<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>state<span class=\"token punctuation\">}</span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>h1<span class=\"token operator\">></span>\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이렇게 횟수를 상태로 두고 클릭시 1만큼 증가하도록하는 함수형 컴포넌트를 예로 설명합니다.</p>\n<p>React에서 함수형 컴포넌트의 상태는 React.useState라는 함수를 통해 생성하고 컨트롤합니다. useState는 함수형 컴포넌트 내부에서 작동하고, 함수 실행시 상태 값과 상태 값을 갱신할수 있는 함수를 반환합니다. </p>\n<p>이제 useState를 직접 만들어 보려합니다.</p>\n<br/>\n<p>위의 예제처럼 함수형 컴포넌트 Counter안에서 useState 함수를 호출합니다. 함수 내부에서 작동하는 useState에서도 사용이 가능하도록 전역 변수를 생성해줍니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">let</span> wipFiber <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n<span class=\"token keyword\">let</span> hookIndex <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">updateFunctionComponent</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fiber</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  wipFiber <span class=\"token operator\">=</span> fiber\n  hookIndex <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n  wipFiber<span class=\"token punctuation\">.</span>hooks <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n  <span class=\"token keyword\">const</span> children <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>fiber<span class=\"token punctuation\">.</span><span class=\"token function\">type</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span>\n  <span class=\"token function\">reconcileChildren</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">,</span> children<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n​\n<span class=\"token keyword\">function</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">initial</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// TODO</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>현재 작업중에 있는 fiber의 접근을 위해 <code class=\"language-text\">wipFiber</code>변수와 해당 fiber에서 useState를 통해 여러개의 상태를 고려해 wipFiber에 hooks 속성을 추가해주며 hookIndex를 통해 트래킹합니다.</p>\n<br/>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">initial</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> oldHook <span class=\"token operator\">=</span>\n    wipFiber<span class=\"token punctuation\">.</span>alternate <span class=\"token operator\">&amp;&amp;</span>\n    wipFiber<span class=\"token punctuation\">.</span>alternate<span class=\"token punctuation\">.</span>hooks <span class=\"token operator\">&amp;&amp;</span>\n    wipFiber<span class=\"token punctuation\">.</span>alternate<span class=\"token punctuation\">.</span>hooks<span class=\"token punctuation\">[</span>hookIndex<span class=\"token punctuation\">]</span>\n  <span class=\"token keyword\">const</span> hook <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    state<span class=\"token operator\">:</span> oldHook <span class=\"token operator\">?</span> oldHook<span class=\"token punctuation\">.</span>state <span class=\"token operator\">:</span> initial<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span>\n​\n  wipFiber<span class=\"token punctuation\">.</span>hooks<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>hook<span class=\"token punctuation\">)</span>\n  hookIndex<span class=\"token operator\">++</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span>hook<span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>함수형 컴포넌트가 useState를 호출하면, 일단 이전에 훅이 있었는지 먼저 확인하는데, wipFiber의 alternate(wipFiber와 대응하는 이전 커밋단계의 fiber)에 있는 hooks를 hookIndex값으로 확인합니다.</p>\n<p>이전 훅이 존재하면 새로 생길 hook객체에 복사 아니면 initial변수로 저장된 초기값을 대입합니다.</p>\n<p>이렇게 훅 객체를 만들어 fiber에 추가하고 hookIndex도 1 증가 시키며 상태값을 반환하게 됩니다.</p>\n<br/>\n<p>이렇게 상태값이 반환되는건 알아보았고 이러한 상태를 갱신할 수 있어야하는데, 이를 위해 action(위 예제에서 카운터의 상태값을 1 올려주는 행위)을 받는 setState라는 함수를 정의합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">initial</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> oldHook <span class=\"token operator\">=</span>\n    wipFiber<span class=\"token punctuation\">.</span>alternate <span class=\"token operator\">&amp;&amp;</span>\n    wipFiber<span class=\"token punctuation\">.</span>alternate<span class=\"token punctuation\">.</span>hooks <span class=\"token operator\">&amp;&amp;</span>\n    wipFiber<span class=\"token punctuation\">.</span>alternate<span class=\"token punctuation\">.</span>hooks<span class=\"token punctuation\">[</span>hookIndex<span class=\"token punctuation\">]</span>\n  <span class=\"token keyword\">const</span> hook <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    state<span class=\"token operator\">:</span> oldHook <span class=\"token operator\">?</span> oldHook<span class=\"token punctuation\">.</span>state <span class=\"token operator\">:</span> initial<span class=\"token punctuation\">,</span>\n    queue<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span>\n​\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">setState</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">action</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    hook<span class=\"token punctuation\">.</span>queue<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>action<span class=\"token punctuation\">)</span>\n    wipRoot <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n      dom<span class=\"token operator\">:</span> currentRoot<span class=\"token punctuation\">.</span>dom<span class=\"token punctuation\">,</span>\n      props<span class=\"token operator\">:</span> currentRoot<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">,</span>\n      alternate<span class=\"token operator\">:</span> currentRoot<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span>\n    nextUnitOfWork <span class=\"token operator\">=</span> wipRoot\n    deletions <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">}</span>\n​\n  wipFiber<span class=\"token punctuation\">.</span>hooks<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>hook<span class=\"token punctuation\">)</span>\n  hookIndex<span class=\"token operator\">++</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span>hook<span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">,</span> setState<span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>받은 action을 바로 실행하지 않고 hook객체의 큐에 넣어 놓습니다. 그리고 render함수와 비슷한 과정을 거치는데, 새로운 wipRoot를 만들어주고 nextUnitOfWork에 대입해줍니다. 이렇게 다음 렌더단계에서 바로 적용할 수 있도록 합니다.</p>\n<br/>\n<p>이제 아까 hook객체의 큐에 넣어둔 action들을 처리하는 과정이 남았습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> actions <span class=\"token operator\">=</span> oldHook <span class=\"token operator\">?</span> oldHook<span class=\"token punctuation\">.</span>queue <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\nactions<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">action</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  hook<span class=\"token punctuation\">.</span>state <span class=\"token operator\">=</span> <span class=\"token function\">action</span><span class=\"token punctuation\">(</span>hook<span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>액션이 실행되는 과정은 setState함수를 통해 render와 유사하게 다음 작업유닛이 생성되고, 그렇게 생성된 다음 렌더단계에서 actions라는 객체에 이제는 oldHook에 해당하는 큐에 액션들이 있는지 확인을 거처 액션들을 수행하고 반환해 상태가 갱신됩니다.</p>\n<h2 id=\"마무리\" style=\"position:relative;\"><a href=\"#%EB%A7%88%EB%AC%B4%EB%A6%AC\" aria-label=\"마무리 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>마무리</h2>\n<p>이렇게 Build your own react라는 글을 통해 리액트에서 굵직(?)한 부분들을 이해를 돕기위한 코드로 작성하며 배워 봤습니다.</p>\n<p>Diact는 react와 완전히 같지 않습니다. 당연히 리액트에서 제공하는 모든게 구현된게 아닙니다. 추후 리액트에서 만든 여러가지 최적화관련 훅들이나 상태를 관리할 때 이번에 배운 내부적인 흐름이 많이 도움이 될것 같습니다.</p>\n<p>참조한 글에서 Diact에 포함되지 않은 React기능들도 정리를 아래와 같이 언급해 주었습니다.</p>\n<ul>\n<li>Diact는 렌더 단계에서 전체 트리를 거치지만, React는 몇몇 힌트를 따라 휴리스틱하게 부분적인 부분은 넘기기도 합니다.</li>\n<li>커밋 단계에서도 Diact는 전체를 다 순회하지만 React는 fiber의 연결리스트를 유지해 영향이 있는 곳만 방문합니다.</li>\n<li>Diact는 wipRoot를 새로 만들때마다 새로운 fiber객체를 만들었지만, React는 이전 트리의 fiber를 재사용합니다.</li>\n<li>Diact는 렌더과정에서 새로운 업데이트 과정이 들어오면 진행중인 wipRoot를 버리고 새로 시작하지만, React는 각 업데이트마다 만료시간을 타임스탬프를 걸고 이 값들을 중 우선수위가 높은 업데이트를 선택합니다.</li>\n<li>이것 말고도 더 있다고 하네요..</li>\n</ul>","fields":{"slug":"/posts/react/6","tagSlugs":["/tag/react/"]},"frontmatter":{"date":"2021-09-10T01:00:00","description":"AUSG 5기 스터디 FE-Deep-Dive 중 Build your own react를 참고해 작성된 포스트입니다. (Step 6)","tags":["react"],"title":"Build your own React (Step 7, 8)","socialImage":{"publicURL":"/static/624cc4a835e68430a8beec01cef8ac6c/photo.jpg"}}}},"pageContext":{"slug":"/posts/react/6"}},"staticQueryHashes":["251939775","401334301","825871152"]}