{"componentChunkName":"component---src-templates-post-template-js","path":"/posts/react/3","result":{"data":{"markdownRemark":{"id":"25490e73-3f37-567f-96e9-dfec4016607e","html":"<blockquote>\n<p>AUSG 5기 스터디 FE-Deep-Dive 중 Build your own react를 참고해 작성된 포스트입니다.</p>\n</blockquote>\n<p>지난주에 JSX와 React.createElement, ReactDOM.render를 직접 만들어보았고,</p>\n<p>이어서 이번 주 스터디 범위, step 3 ~ 5까지의 내용으로 Concurrent Mode와 fiber 자료구조 그리고 fiber를 이용해서 렌더링 하는 과정을 알아보았습니다.</p>\n<p>일단 <a href=\"https://jeoungsulmo.github.io/posts/react/2\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">지난주</a>까지 완성된 코드를 보면,</p>\n<h6 id=\"indexjs\" style=\"position:relative;\"><a href=\"#indexjs\" aria-label=\"indexjs permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>index.js</h6>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">createTextElement</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">text</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    type<span class=\"token operator\">:</span> <span class=\"token string\">\"TEXT_ELEMENT\"</span><span class=\"token punctuation\">,</span>\n    props<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      nodeValue<span class=\"token operator\">:</span> text<span class=\"token punctuation\">,</span>\n      children<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n​\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">type<span class=\"token punctuation\">,</span> props<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span>children</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    type<span class=\"token punctuation\">,</span>\n    props<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token operator\">...</span>props<span class=\"token punctuation\">,</span>\n      children<span class=\"token operator\">:</span> children<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">child</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span>\n        <span class=\"token keyword\">typeof</span> child <span class=\"token operator\">===</span> <span class=\"token string\">\"object\"</span> <span class=\"token operator\">?</span> child <span class=\"token operator\">:</span> <span class=\"token function\">createTextElement</span><span class=\"token punctuation\">(</span>child<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Type과 props 그리고 자식요소를 인자로 받아 재귀적으로 엘리먼트를 구성하고,</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">/** @jsx Didact.createElement */</span>\n<span class=\"token keyword\">const</span> element <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>\n  <span class=\"token operator\">&lt;</span>div id<span class=\"token operator\">=</span><span class=\"token string\">\"foo\"</span><span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span>a<span class=\"token operator\">></span>bar<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>a<span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span>b <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n  <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>해당 정보를 JSX를 통해 좀 더 시각적으로 엘리먼트들을 표현 했습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">​\n<span class=\"token keyword\">function</span> <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">element<span class=\"token punctuation\">,</span> container</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> dom <span class=\"token operator\">=</span>\n    element<span class=\"token punctuation\">.</span>type <span class=\"token operator\">==</span> <span class=\"token string\">\"TEXT_ELEMENT\"</span>\n      <span class=\"token operator\">?</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createTextNode</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span>\n      <span class=\"token operator\">:</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span>element<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">)</span>\n​\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">isProperty</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">key</span> <span class=\"token operator\">=></span> key <span class=\"token operator\">!==</span> <span class=\"token string\">\"children\"</span>\n  Object<span class=\"token punctuation\">.</span><span class=\"token function\">keys</span><span class=\"token punctuation\">(</span>element<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span>isProperty<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">name</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      dom<span class=\"token punctuation\">[</span>name<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> element<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">[</span>name<span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n​\n  element<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">child</span> <span class=\"token operator\">=></span>\n    <span class=\"token function\">render</span><span class=\"token punctuation\">(</span>child<span class=\"token punctuation\">,</span> dom<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">)</span>\n​\n  container<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>dom<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n​\n<span class=\"token keyword\">const</span> Didact <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  createElement<span class=\"token punctuation\">,</span>\n  render<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span>\n​\n<span class=\"token keyword\">const</span> container <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"root\"</span><span class=\"token punctuation\">)</span>\nDidact<span class=\"token punctuation\">.</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span>element<span class=\"token punctuation\">,</span> container<span class=\"token punctuation\">)</span></code></pre></div>\n<p>그렇게 생성한 element 객체를 render 함수를 통해 DOM노드로 만들었고, render또한 재귀호출로 실행되어 돔노드들이 모이고 돔트리를 구성 시켰습니다.</p>\n<p>여기까지가 저번주에 구성했던 부분들입니다!</p>\n<h3 id=\"step-3-concurrent-mode\" style=\"position:relative;\"><a href=\"#step-3-concurrent-mode\" aria-label=\"step 3 concurrent mode permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Step 3: Concurrent Mode</h3>\n<p>저번주까지의 작업중 문제가 하나 있습니다.</p>\n<p>지난주에 작성한 코드중 render함수가 재귀호출되는 부분입니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">element<span class=\"token punctuation\">,</span> container</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...</span>\n  element<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">child</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">render</span><span class=\"token punctuation\">(</span>child<span class=\"token punctuation\">,</span> dom<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>재귀는 중간에 함수 호출을 끊을 수 없기 때문에 렌더링이 시작하면 우리는 돔 트리가 다 만들어지기 전까지 멈출 수 없습니다. 만약 돔 트리의 크기가 크다고 가정해봅시다.</p>\n<p>브라우저의 내부적으로 동작하는 JS가 단일 스레드로 동작하기 때문에 돔 트리 전체가 구성되는 동안 브라우저에서 영상 재생이나 사용자 입력과 같은 운선순위가 높은 작업을 실행해야 한다면 렌더링이 끝날 때까지 기다려야 합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">let</span> nextUnitOfWork <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n​\n<span class=\"token keyword\">function</span> <span class=\"token function\">workLoop</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">deadline</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> shouldYield <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>nextUnitOfWork <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>shouldYield<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    nextUnitOfWork <span class=\"token operator\">=</span> <span class=\"token function\">performUnitOfWork</span><span class=\"token punctuation\">(</span>\n      nextUnitOfWork\n    <span class=\"token punctuation\">)</span>\n    shouldYield <span class=\"token operator\">=</span> deadline<span class=\"token punctuation\">.</span><span class=\"token function\">timeRemaining</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">1</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token function\">requestIdleCallback</span><span class=\"token punctuation\">(</span>workLoop<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n​\n<span class=\"token function\">requestIdleCallback</span><span class=\"token punctuation\">(</span>workLoop<span class=\"token punctuation\">)</span>\n​\n<span class=\"token keyword\">function</span> <span class=\"token function\">performUnitOfWork</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">nextUnitOfWork</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// TODO: add dom node</span>\n  <span class=\"token comment\">// TODO: create new fibers</span>\n  <span class=\"token comment\">// TODO: return next unit of work</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>그래서 작업 단위를 작은 유닛으로 나누고, 각 유닛의 작업이 완료된 이후 브라우저에서 다른 작업이 필요한 경우, 진행중이던 렌더링을 중단시킬 수 있도록 합니다.</p>\n<p>여기서 <a href=\"https://developer.mozilla.org/ko/docs/Web/API/Window/requestIdleCallback\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code class=\"language-text\">requestIdleCallback</code></a>를 사용합니다. 브라우저의 메인 스레드(JavaScript 실행 등을 담당하는 스레드)가 유휴상태일때, 지정한 콜백 함수를 실행하도록 지시할 수 있는 함수입니다.</p>\n<p><span style=\"color : #999999\">리액트는 <code class=\"language-text\">requestIdleCallback</code>을 사용하지 않고 현재 <a href=\"https://github.com/facebook/react/tree/main/packages/scheduler\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">scheduler package</a>를 사용합니다. 개념적으로 같은 형태이니 이해하는데 무리는 없다고 합니다.</span></p>\n<p>그리고 requestIdleCallback은 callback함수의 인자값으로 deadline 파라미터를 반환합니다. 이를 통해 우리는 브라우저가 다시 제어권을 가질 때까지 얼마나 걸리는지 확인할 수 있습니다.</p>\n<p><code class=\"language-text\">performUnitOfWork</code>함수에서는 반복을 위해 첫번째 작업단위가 필요로하고, 작업을 실행한 뒤 다음 작업을 반환 하도록 만들 예정입니다. 자세한 내용은 아래에서 더 이어집니다.</p>\n<h3 id=\"step-4--fibers\" style=\"position:relative;\"><a href=\"#step-4--fibers\" aria-label=\"step 4  fibers permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Step 4 : Fibers</h3>\n<p>작업 단위를 생성하기 위해 Fibar tree라는 자료구조가 필요합니다.</p>\n<p>각 element마다 하나의 fiber를 가지고 각 fiber는 작업의 단위가 됩니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">Didact<span class=\"token punctuation\">.</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span>\n  <span class=\"token operator\">&lt;</span>div<span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span>h1<span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span>p <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n      <span class=\"token operator\">&lt;</span>a <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>h1<span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span>h2 <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n  <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span><span class=\"token punctuation\">,</span>\n  container\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>위와 같은 트리를 그린다고 가정할 때,</p>\n<p><code class=\"language-text\">render</code>함수에서 우리는 container에 해당하는 root element 에대한 fiber를 만들고 <code class=\"language-text\">nextUnitOfWork</code> 변수에 할당합니다. 이후 <code class=\"language-text\">performUnitOfWork</code> 함수를 통해 우리는 각각의 fiber마다 3가지 처리를 진행합니다.</p>\n<ol>\n<li>DOM에 요소 추가하기</li>\n<li>진행중인 element의 자식 요소를 fiber로 생성</li>\n<li>다음 작업 단위 선택</li>\n</ol>\n<p>이 자료구조의 목표 중 하나는 <strong>쉽게 다음 작업 단위를 찾는 것</strong> 입니다. 그래서 fiber는 자기 자신을 기준으로 자식, 부모, 형제와 연결되어있습니다.</p>\n<h4 id=\"fiber-탐색-순서\" style=\"position:relative;\"><a href=\"#fiber-%ED%83%90%EC%83%89-%EC%88%9C%EC%84%9C\" aria-label=\"fiber 탐색 순서 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>fiber 탐색 순서</h4>\n<p>다음은 파이버자료구조가 렌더링을 할때 탐색을 하는 순서입니다.</p>\n<span class=\"gatsby-resp-image-wrapper\" style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 834px; \">\n      <a class=\"gatsby-resp-image-link\" href=\"/static/44797b03b3c1c09d9708307158548727/5d72a/fiber1.png\" style=\"display: block\" target=\"_blank\" rel=\"noopener\">\n    <span class=\"gatsby-resp-image-background-image\" style=\"padding-bottom: 116.66666666666667%; position: relative; bottom: 0; left: 0; background-image: url(&apos;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAXCAYAAAALHW+jAAAACXBIWXMAABYlAAAWJQFJUiTwAAAC4UlEQVQ4y41V2XbaMBDlO1Lwbsu7DQFCiJ2QBQ5JGsjW9NAmzf9/xe2MvEIhpw+DLGl0de/MaOhohoPKVN2ux65q4qiro0djtabq7GfvtWqv0wZsg84XS6wfn/H0/ArPj1vADpTSelphit6cPQjYH4wxzS4wnpzBtL2aobAtDHwDoWvioq/hNethOVZwpNj/MmxLVjRLjrop5He1blgE6rpwHIFR6iAfCUyHLoTn72dYHbQcD44I4Ljh1kWOEEhiD1HkY7kY4ml9gtX9CNmUwqIRYOW8y9BxCzDL8bf2dduHGQxguRGCkxzR7A5BNoedjKGSEsmQA94GVmiuqIXkbs+Q8zagFfRhCALMFkjnayQ3K7I1+RnocIxu774jiFKibMlb7CDGbLnEj5c3ZNc38PrH8oK6fJgA+SkKlVVPk8bfvC8Zbn69I0mHNVND+Jicz3B1tcDw9IwuiAqAlorGRGll2YRRHz9/bihzYZ1NOaoaNM2QziyZlbQT1Nh2Djp+kCDtj1qOtizW2LMQ+w5sN64PCS+SSdqXyMqk5JfXN4TxQErWad4lwOPQxCC0YDhhAVjWpk2ltAu6xZBfwfvHJ5L+EF2FpXHWbfiWBmGq8lttFTaDsnxZHYqBbz2dzjWV0GGg948/cEmOjB09L92i4h1PcXE5R3w8IpZe+UpcaUyCfZPRCfLzS0zzGUSUFAw50KfTXDrKktCKLGeLOVYPawzzXDozAwayaU94RQIn19d4WD1icXePaDKRax3+YdpbgaY1llMwtgs5JJMvrd64VhY9x12R/maTlCom7afHbPgtc2ardY8qolJyqAd80Rz8rYxWxiE6BPpfgMy+zZxH7kRNF2+slryvJzKQNGKzW8AyRDyX+0VsNfMLhhzkNMvw+/MT+e2yfsPMmtuaS38JnDgnTvG02eD25RmGFzTt6xDLmBrGruRanl72Ta/omVUfOCiZRy6F3fjVfuX7ZqD2X8RfJIGcX/ULMX4AAAAASUVORK5CYII=&apos;); background-size: cover; display: block;\"></span>\n  <picture>\n        <source srcset=\"/static/44797b03b3c1c09d9708307158548727/8ac56/fiber1.webp 240w,\n/static/44797b03b3c1c09d9708307158548727/d3be9/fiber1.webp 480w,\n/static/44797b03b3c1c09d9708307158548727/e1262/fiber1.webp 834w\" sizes=\"(max-width: 834px) 100vw, 834px\" type=\"image/webp\">\n        <source srcset=\"/static/44797b03b3c1c09d9708307158548727/8ff5a/fiber1.png 240w,\n/static/44797b03b3c1c09d9708307158548727/e85cb/fiber1.png 480w,\n/static/44797b03b3c1c09d9708307158548727/5d72a/fiber1.png 834w\" sizes=\"(max-width: 834px) 100vw, 834px\" type=\"image/png\">\n        <img class=\"gatsby-resp-image-image\" src=\"/static/44797b03b3c1c09d9708307158548727/5d72a/fiber1.png\" alt=\"fiber1\" title=\"fiber1\" loading=\"lazy\" style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\">\n      </picture>\n  </a>\n    </span>\n<ol>\n<li>현재 fiber에 대한 작업을 마쳤을 때, 작업을 마친 fiber의 자식 요소가 있다면 그 자식 요소는 다음 작업 단위가 됩니다.\n(위 그림에서는 <code class=\"language-text\">div</code>의 작업이 끝나면 <code class=\"language-text\">h1</code>fiber가 다음 작업 단위가 됩니다.)</li>\n<li>자식이 없다면 형제 fiber를 다음 작업 단위로 사용합니다.\n(위 그림에서 <code class=\"language-text\">p</code>태그가 완료 시 형제인 <code class=\"language-text\">a</code>가 다음 작업 단위)</li>\n<li>자식과 형제 fiber 둘 다 없을 경우 삼촌(부모의 형제)fiber로 가게 됩니다.\n(위 그림에서 <code class=\"language-text\">a</code>태그가 완료 시 부모의 형제인 <code class=\"language-text\">h1</code>이다음 작업 단위가 된다.)</li>\n<li>만약 부모 또한 형제가 없을 시 지속해서 조상 fiber에 단계적으로 접근하며 형제가 있는 조상을 찾거나 root fiber까지 접근하고, root에 접근하는 것은 이번 render에 대한 모든 작업 진행이 완료된 것입니다.</li>\n</ol>\n<h4 id=\"fiber를-이용한-코드의-변화\" style=\"position:relative;\"><a href=\"#fiber%EB%A5%BC-%EC%9D%B4%EC%9A%A9%ED%95%9C-%EC%BD%94%EB%93%9C%EC%9D%98-%EB%B3%80%ED%99%94\" aria-label=\"fiber를 이용한 코드의 변화 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>fiber를 이용한 코드의 변화</h4>\n<p>이제 위에서 알아본 fiber 자료구조가 사용된 코드를 보겠습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">createDom</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fiber</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> dom <span class=\"token operator\">=</span>\n    fiber<span class=\"token punctuation\">.</span>type <span class=\"token operator\">==</span> <span class=\"token string\">\"TEXT_ELEMENT\"</span>\n      <span class=\"token operator\">?</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createTextNode</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"\"</span><span class=\"token punctuation\">)</span>\n      <span class=\"token operator\">:</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">isProperty</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">key</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> key <span class=\"token operator\">!==</span> <span class=\"token string\">\"children\"</span><span class=\"token punctuation\">;</span>\n\n  Object<span class=\"token punctuation\">.</span><span class=\"token function\">keys</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span>isProperty<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">name</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      dom<span class=\"token punctuation\">[</span>name<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> fiber<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">[</span>name<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">return</span> dom<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">element<span class=\"token punctuation\">,</span> container</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  nextUnitOfWork <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    dom<span class=\"token operator\">:</span> container<span class=\"token punctuation\">,</span>\n    props<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      children<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>element<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>일단 <a href=\"#indexjs\">지난주 코드</a>에서 <code class=\"language-text\">render</code> 함수의 DOM 노드 생성 부분을 createDom 함수로 정의하고, render함수는 다음 작업 단위로 fiber tree의 루트를 container(root element)로 만들어 할당합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">workLoop</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">deadline</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> shouldYield <span class=\"token operator\">=</span> <span class=\"token boolean\">false</span>\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>nextUnitOfWork <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>shouldYield<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    nextUnitOfWork <span class=\"token operator\">=</span> <span class=\"token function\">performUnitOfWork</span><span class=\"token punctuation\">(</span>\n      nextUnitOfWork\n    <span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// 주어진 idle 시간이 1ms 보다 적다면 break</span>\n    shouldYield <span class=\"token operator\">=</span> deadline<span class=\"token punctuation\">.</span><span class=\"token function\">timeRemaining</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">1</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token function\">requestIdleCallback</span><span class=\"token punctuation\">(</span>workLoop<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n​\n<span class=\"token comment\">// 브라우저가 준비가 되면</span>\n<span class=\"token function\">requestIdleCallback</span><span class=\"token punctuation\">(</span>workLoop<span class=\"token punctuation\">)</span>\n​\n<span class=\"token keyword\">function</span> <span class=\"token function\">performUnitOfWork</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fiber</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// TODO add dom node</span>\n  <span class=\"token comment\">// TODO create new fibers</span>\n  <span class=\"token comment\">// TODO return next unit of work</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이제 <code class=\"language-text\">requestIdleCallback</code>을 통해 브라우저가 준비가 되면 우리의 <code class=\"language-text\">workLoop</code>함수를 호출하고 root fiber에서 작업이 시작될 겁니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">performUnitOfWork</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fiber</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>fiber<span class=\"token punctuation\">.</span>dom<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    fiber<span class=\"token punctuation\">.</span>dom <span class=\"token operator\">=</span> <span class=\"token function\">createDom</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n​\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>parent<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    fiber<span class=\"token punctuation\">.</span>parent<span class=\"token punctuation\">.</span>dom<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>dom<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n​\n  <span class=\"token comment\">// TODO create new fibers</span>\n  <span class=\"token comment\">// TODO return next unit of work</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>먼저 <code class=\"language-text\">performUnitOfWork</code>함수에서 새로운 DOM노드를 생성하고 추가한 DOM노드는 fiber.dom 속성에 할당합니다.</p>\n<p>부모 파이버가 존재한다면 부모 파이버의 dom에 방금 만든 dom을 appendChild 시킵니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">performUnitOfWork</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fiber</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...</span>\n  <span class=\"token keyword\">const</span> elements <span class=\"token operator\">=</span> fiber<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">.</span>children\n  <span class=\"token keyword\">let</span> index <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n  <span class=\"token keyword\">let</span> prevSibling <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n​\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>index <span class=\"token operator\">&lt;</span> elements<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> element <span class=\"token operator\">=</span> elements<span class=\"token punctuation\">[</span>index<span class=\"token punctuation\">]</span>\n​\n    <span class=\"token keyword\">const</span> newFiber <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n      type<span class=\"token operator\">:</span> element<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">,</span>\n      props<span class=\"token operator\">:</span> element<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">,</span>\n      parent<span class=\"token operator\">:</span> fiber<span class=\"token punctuation\">,</span>\n      dom<span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">// TODO return next unit of work</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>다음으로 자식요소들은 새로운 fiber노드로 각각 생성해 줍니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">  <span class=\"token comment\">// ...</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>index <span class=\"token operator\">===</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    fiber<span class=\"token punctuation\">.</span>child <span class=\"token operator\">=</span> newFiber\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    prevSibling<span class=\"token punctuation\">.</span>sibling <span class=\"token operator\">=</span> newFiber\n  <span class=\"token punctuation\">}</span>\n​\n  prevSibling <span class=\"token operator\">=</span> newFiber\n  index<span class=\"token operator\">++</span></code></pre></div>\n<p>자식요소들중 첫번째 자식을 fiber.child에 이후로는 해당 자식요소의 형제로 연결합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// ...</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>child<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> fiber<span class=\"token punctuation\">.</span>child<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">let</span> nextFiber <span class=\"token operator\">=</span> fiber<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>nextFiber<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>nextFiber<span class=\"token punctuation\">.</span>sibling<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> nextFiber<span class=\"token punctuation\">.</span>sibling<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  nextFiber <span class=\"token operator\">=</span> nextFiber<span class=\"token punctuation\">.</span>parent<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>마지막으로 다음 작업을 탐색하는 과정이 필요한데, 위에서 본 fiber의 탐색 순서와 같이 <strong>자식 파이버 다음으로 형제 그리고 부모의 형제 순으로 탐색</strong>하게 됩니다.</p>\n<p>아래의 코드는 <code class=\"language-text\">performUnitOfWork</code>함수의 전체 코드입니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">performUnitOfWork</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fiber</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>fiber<span class=\"token punctuation\">.</span>dom<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    fiber<span class=\"token punctuation\">.</span>dom <span class=\"token operator\">=</span> <span class=\"token function\">createDom</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n​\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>parent<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    fiber<span class=\"token punctuation\">.</span>parent<span class=\"token punctuation\">.</span>dom<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>dom<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">const</span> elements <span class=\"token operator\">=</span> fiber<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">.</span>children\n  <span class=\"token keyword\">let</span> index <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n  <span class=\"token keyword\">let</span> prevSibling <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n​\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>index <span class=\"token operator\">&lt;</span> elements<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> element <span class=\"token operator\">=</span> elements<span class=\"token punctuation\">[</span>index<span class=\"token punctuation\">]</span>\n​\n    <span class=\"token keyword\">const</span> newFiber <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n      type<span class=\"token operator\">:</span> element<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">,</span>\n      props<span class=\"token operator\">:</span> element<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">,</span>\n      parent<span class=\"token operator\">:</span> fiber<span class=\"token punctuation\">,</span>\n      dom<span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>index <span class=\"token operator\">===</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      fiber<span class=\"token punctuation\">.</span>child <span class=\"token operator\">=</span> newFiber\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      prevSibling<span class=\"token punctuation\">.</span>sibling <span class=\"token operator\">=</span> newFiber\n    <span class=\"token punctuation\">}</span>\n​\n    prevSibling <span class=\"token operator\">=</span> newFiber\n    index<span class=\"token operator\">++</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>child<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> fiber<span class=\"token punctuation\">.</span>child\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">let</span> nextFiber <span class=\"token operator\">=</span> fiber\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>nextFiber<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>nextFiber<span class=\"token punctuation\">.</span>sibling<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> nextFiber<span class=\"token punctuation\">.</span>sibling\n    <span class=\"token punctuation\">}</span>\n    nextFiber <span class=\"token operator\">=</span> nextFiber<span class=\"token punctuation\">.</span>parent\n  <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이렇게 작업단위를 나눠 화면을 그릴수 있도록 만들어 보았습니다.</p>\n<h3 id=\"step-5-render-and-commit-phases\" style=\"position:relative;\"><a href=\"#step-5-render-and-commit-phases\" aria-label=\"step 5 render and commit phases permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Step 5: Render and Commit Phases</h3>\n<p>화면은 잘 그려지지만 여기서 문제가 또 하나 있습니다.</p>\n<p>우리가 파이버를 DOM 노드로 만들때 마다 바로 돔 트리에 append 했습니다. 브라우저는 전체 렌더링이 끝나기 전에 우리의 작업에 의해 인터럽트가 발생하고 이렇게 되면 사용자는 가끔 생기다 만 불안전한 UI를 보게 됩니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">performUnitOfWork</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fiber</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>fiber<span class=\"token punctuation\">.</span>dom<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    fiber<span class=\"token punctuation\">.</span>dom <span class=\"token operator\">=</span> <span class=\"token function\">createDom</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n​\n<span class=\"token comment\">// 이부분 제거</span>\n<span class=\"token comment\">//  if (fiber.parent) {</span>\n<span class=\"token comment\">//    fiber.parent.dom.appendChild(fiber.dom)</span>\n<span class=\"token comment\">//  }</span>\n\n<span class=\"token comment\">// ...</span></code></pre></div>\n<p>그래서 우리는 작업 단위마다 DOM을 변형시키는 위에 코드 부분을 제거 합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">element<span class=\"token punctuation\">,</span> container</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  wipRoot <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">// 수정</span>\n    dom<span class=\"token operator\">:</span> container<span class=\"token punctuation\">,</span>\n    props<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      children<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>element<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span>\n  nextUnitOfWork <span class=\"token operator\">=</span> wipRoot <span class=\"token comment\">// 추가</span>\n<span class=\"token punctuation\">}</span>\n​\n<span class=\"token keyword\">let</span> nextUnitOfWork <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n<span class=\"token keyword\">let</span> wipRoot <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span> <span class=\"token comment\">// 추가</span>\n​</code></pre></div>\n<p>대신 파이버트리의 root를 추적하는데, 우리는 그것을 work in progress root 또는 wipRoot라고 부를 겁니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// 새 함수 추가</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">commitRoot</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// TODO add nodes to dom</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">workLoop</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">deadline</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...</span>\n  <span class=\"token comment\">// 추가</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>nextUnitOfWork <span class=\"token operator\">&amp;&amp;</span> wipRoot<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">commitRoot</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>모든 작업이 한번 끝나면(다음 작업단위가 없는 상태) 우리는 전체 파이버 트리를 DOM에 커밋합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">commitRoot</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">commitWork</span><span class=\"token punctuation\">(</span>wipRoot<span class=\"token punctuation\">.</span>child<span class=\"token punctuation\">)</span>\n  wipRoot <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n<span class=\"token punctuation\">}</span>\n​\n<span class=\"token keyword\">function</span> <span class=\"token function\">commitWork</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fiber</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>fiber<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">const</span> domParent <span class=\"token operator\">=</span> fiber<span class=\"token punctuation\">.</span>parent<span class=\"token punctuation\">.</span>dom\n  domParent<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>dom<span class=\"token punctuation\">)</span>\n  <span class=\"token function\">commitWork</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>child<span class=\"token punctuation\">)</span>\n  <span class=\"token function\">commitWork</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>sibling<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이렇게 <code class=\"language-text\">commitRoot</code>함수를 통해 재귀적으로 요소들을 돔트리에 한번에 추가하게 됩니다.</p>\n<h4 id=\"참고\" style=\"position:relative;\"><a href=\"#%EC%B0%B8%EA%B3%A0\" aria-label=\"참고 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>참고</h4>\n<ul>\n<li><a href=\"https://pomb.us/build-your-own-react/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">build your own React</a></li>\n<li><a href=\"https://engineering.linecorp.com/ko/blog/line-securities-frontend-4/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">requestIdleCallback 사용사례</a></li>\n<li><a href=\"https://yeoulcoding.tistory.com/144\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">브라우저 단일 스레드</a></li>\n<li><a href=\"https://blog.eunsukim.me/posts/using-react-fiber-to-concurrent-rendering\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">스장님의 포스트</a></li>\n<li><a href=\"https://codesquad-yoda.medium.com/%EB%82%A8%EB%8B%A4%EB%A5%B8-%EA%B0%9C%EC%84%A0%EB%B0%A9%EB%B2%95%EC%9D%84-%EB%8B%A4%EC%8B%9C-%EB%B3%B4%EC%97%AC%EC%A4%80-%ED%8E%98%EC%9D%B4%EC%8A%A4%EB%B6%81%EC%9D%98-react-fiber-80b7ca5bd9bb\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">fiber</a></li>\n<li><a href=\"https://developers.google.com/web/updates/2018/09/inside-browser-part3?hl=ko\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">브라우저 렌더링</a></li>\n</ul>","fields":{"slug":"/posts/react/3","tagSlugs":["/tag/react/"]},"frontmatter":{"date":"2021-08-21T01:00:00","description":"AUSG 5기 스터디 FE-Deep-Dive 중 Build your own react를 참고해 작성된 포스트입니다. (Step 3,4,5)","tags":["react"],"title":"Build your own React (Step 3,4,5)","socialImage":{"publicURL":"/static/624cc4a835e68430a8beec01cef8ac6c/photo.jpg"}}}},"pageContext":{"slug":"/posts/react/3"}},"staticQueryHashes":["251939775","401334301","825871152"]}